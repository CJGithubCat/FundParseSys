<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zsh.labouCapital.dao.CompanyMapper">

	<!-- 查询参数 -->
	<sql id="queryParams">
		<where>
			<trim prefixOverrides="and|or">
				<if test="companyId!=null">
					and tc.company_id =#{companyId}
				</if>
				<if test="companyName!=null and companyName!=''">
					and tc.company_name like '%${companyName}%'
				</if>
				<if test="companyPath!=null and companyPath!=''">
					and tcp.company_path like (#{companyPath}+'%')
				</if>
				and tc.is_deleted=0
			</trim>
		</where>
	</sql>

	<insert id="add" parameterType="com.zsh.labouCapital.entity.Company" useGeneratedKeys="true" keyProperty="companyId" keyColumn="company_id">
		insert into t_company(company_name,company_address,company_post,work_phone,fax,leader,leader_phone,parent_company_id,company_type,is_deleted)
		values(#{companyName},#{companyAddress},#{companyPost},#{workPhone},#{fax},#{leader},#{leaderPhone},#{parentCompanyId},#{companyType},#{isDeleted})
	</insert>
	
	<!-- 根据Id查询机构 -->
	<select id="findById" parameterType="string" resultType="com.zsh.labouCapital.entity.Company">
		select tc.*,
			   tcp.company_path
		from t_company tc
		inner join t_company_path tcp on tc.company_id = tcp.company_id
		where tc.company_id =#{companyId}
		and tc.is_deleted = 0
	</select>
	
	<!-- 刷新机构路劲表 -->
	<select id="refreshCompanyPath"  statementType="CALLABLE">  
		<![CDATA[  
		    {call p_refresh_mv_agency()}  
		]]>  
	</select>
	
	<select id="getCompanyPathById" parameterType="Integer" resultType="String">
		select tcp.company_path
		from t_company_path tcp
		inner join t_company tc on tcp.company_id = tc.company_id
		where tc.company_id = #{companyId}
	</select>
	
	<select id="getCountByCompanyName" parameterType="map" resultType="Integer">
		select count(*) 
		from t_company tc 
		where tc.company_id = #{companyId} 
		and tc.company_name = #{companyName}
		and tc.is_deleted = 0
	</select>
	
	<update id="edit" parameterType="com.zsh.labouCapital.entity.Company">
		UPDATE t_company 
		<set>
			<if test="companyName !=null and companyName != ''">
				company_name = #{companyName},
			</if>
			<if test="companyPost !=null and companyPost != ''">
				company_post = #{companyPost},
			</if>
			<if test="companyType !=null and companyType != ''">
				company_type = #{companyType},
			</if>
			<if test="companyAddress !=null and companyAddress != ''">
				company_address = #{companyAddress},
			</if>
			<if test="leader !=null and leader != ''">
				leader = #{leader},
			</if>
			<if test="leaderEmail !=null and leaderEmail != ''">
				leader_email = #{leaderEmail},
			</if>
			<if test="leaderPhone !=null and leaderPhone != ''">
				leader_phone = #{leaderPhone},
			</if>
			<if test="fax !=null and fax != ''">
				fax = #{fax},
			</if>
			<if test="parentCompanyId!=0">
		        parent_company_id = #{parentCompanyId},
			</if>
			<if test="workPhone !=null and workPhone != ''">
				work_phone = #{workPhone}
			</if>
		</set>
		where company_id = #{companyId}
	</update>
	
	<!-- <delete id="removeById" parameterType="String">
		delete t_company tc where tc.company_id = #{companyId}
	</delete> -->
	<!-- 逻辑删除机构 -->
	<update id="removeById">
		update t_company set is_deleted = 1 where company_id = #{companyId}
	</update>
	
	<!-- 根据parentAgencyId查询子机构-->
	<select id="queryChildrenCompanyById" parameterType="integer" resultType="com.zsh.labouCapital.entity.Company">
		select tc.*,
			   tcp.company_path
		from t_company tc
		inner join t_company_path tcp on tcp.company_id = tc.company_id
		where tc.parent_company_id = #{parentCompanyId}
		and tc.is_deleted = 0
		order by tc.company_name asc
	</select>
	
	<!-- 根据AgencyName查询机构-->
	<select id="queryCompanyByCompanyName" parameterType="string" resultType="com.zsh.labouCapital.entity.Company">
		SELECT tc.*,
			   tcp.company_path 
		from t_company tc
		inner join t_company_path tcp on tc.company_id = tcp.company_id
		where  tc.company_name = #{companyName} 
		and tc.is_deleted = 0
		order by tc.company_name asc;
	</select>
	
	<select id="getCompanyBySelfAndParentName" resultType="com.zsh.labouCapital.entity.Company" parameterType="map">
		select tc.* 
		from t_company tc
		inner join t_company_path tcp on tc.company_id = tcp.company_id
		where tc.company_name = #{ownCompanyName}
		<if test="parentCompanyName != null and parentCompanyName != ''">
			and tc.parent_company_id = (
				select tt.company_id 
				from t_company tt 
				where tt.company_name = #{parentCompanyName}
			)
		</if>
		and tc.company_type = #{companyType}
	</select>
	<select id="getAllCompanyNameByAgencyId" parameterType="string" resultType="string">
     select tcp.company_name
	 from t_company_path tcp
	 where tcp.company_path like (
	 	(select t.company_path 
	 	 from t_company_path t 
	 	 where t.company_id = #{companyId}
	 	 ) + '%')
	 order by  tcp.company_name asc;
	</select>
	
	<select id="queryCompanyMaxLength" parameterType="com.zsh.labouCapital.entity.Company" resultType="int">
		SELECT 
		  	MAX(LEN(companyPath) - LEN(REPLACE(companyPath, ',', ''))) - (LEN(#{companyPath}) - LEN(REPLACE(#{companyPath},',', ''))) + 1
		  FROM 
		 (select tcp.company_path as companyPath
			from t_company tc
			inner join t_company_path tcp on tc.company_id = tcp.company_id
			where tcp.company_path like (#{companyPath}+'%')
			and tc.is_deleted = 0
		 )nums 
	</select>
	
	<select id="getAllCompanyIdToName" resultType="map">  
    	select tcp.company_id as companyId,
    		   tcp.company_name as companyName,
    		   tcp.company_path as companyPath 
    	FROM t_company_path tcp
    </select>
    
    <select id="queryCompanyPage" parameterType="com.zsh.labouCapital.entity.Company" resultType="map">
    	select tc.company_id as companyId,
    		   tc.company_name as companyName,
    		   tc.company_address as companyAddress,
    		   tc.work_phone as workPhone,
    		   tc.fax,
    		   tc.leader,
    		   tc.leader_phone as leaderPhone,
    		   tc.leader_email as leaderEmail,
    		   tc.parent_company_id as parentCompanyId,
    		   tc.is_deleted as isDeleted,
    		   tcp.company_path as companyPath
		from t_company tc
		inner join t_company_path tcp on tcp.company_id = tc.company_id
    	<include refid="queryParams"/>
    	ORDER BY tc.company_id ASC
    </select>
    
    <select id="countQueryCompany" parameterType="com.zsh.labouCapital.entity.Company" resultType="integer">
		select count(*)
		from t_company tc
		inner join t_company_path tcp on tcp.company_id = tc.company_id
    	<include refid="queryParams"/>
	</select>
    
</mapper>